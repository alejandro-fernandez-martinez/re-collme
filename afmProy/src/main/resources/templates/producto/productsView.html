<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:insert="/fragmentos.html::cabecera">
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Productos CRUD</title>
</head>

<body>
  <nav th:replace="/fragmentos.html::menu"></nav>
  <nav th:replace="/fragmentos.html::menuAdmin"></nav>
  <img src="/images/productos.png" width="500px" />
  <h1>Listado de productos</h1>

  <select id="select" onChange="changeCategory();">
    <option value="0">Todas</option>
    <option
      th:each="cat : ${listaCategorias}"
      th:value="${cat.idCat}"
      th:text="${cat.nomCat}"
      th:selected="${cat.nomCat} == ${categoriaSeleccionada} ? true : false"
    ></option>
  </select>
  <!-- <span th:text="${categoriaSeleccionada}">Cristales</span> -->

  <script>
    function changeCategory() {
      window.location.href =
        "/producto/categoria/" + document.getElementById("select").value;
    }
  </script>


  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>Código LER</th>
        <th>Cantidad</th>
        <th>Unidades de medida</th>
        <th>Precio</th>
        <th>Reservado</th>
        <th>Disponibilidad</th>
        <th>Vendedor</th>
        <th>Vendido</th>
        <th sec:authorize="!isAuthenticated()">Añadir a pedido</th>
        <th sec:authorize="hasRole('NEGOCIANTE')">Añadir a pedido</th>
        <!-- (solo si autenticado) -->
        <th sec:authorize="isAuthenticated()">Editar producto</th>
        <th sec:authorize="isAuthenticated()">Borrar producto</th>
      </tr>
    </thead>

    <tbody>
      <tr th:each="producto : ${listaProductos}">
        <td th:text="${producto.nomProd}">nomProd</td>
        <td th:text="${producto.categoria.nomCat}">categoria</td>
        <td th:text="${producto.codLer}">codLer</td>
        <td th:text="${producto.cantProd}">cantProd</td>
        <td th:text="${producto.udMedida}">udMedida</td>
        <td th:text="${producto.precioProd}">precioProd</td>
        <td th:text="${producto.reservado}">reservado</td>
        <td th:text="${producto.frecProd}">frecProd</td>
        <td th:text="${producto.vendedor.nomUser}">nomUser</td>
        <td th:text="${producto.Vendido}">vendido</td>
        <!-- (botón falso de comprar para no autenticados) -->
        <td sec:authorize="!isAuthenticated()"><a th:href="@{/producto/comprar/id}">comprar</a></td>
        <!-- (solo si Negociante puede comprar) -->
        <td sec:authorize="hasAnyRole('NEGOCIANTE', 'ADMIN')"><a th:href="@{/producto/comprar/{id}(id=${producto.idProd})}">comprar</a></td>
        <!-- (solo si autenticado) --> <!-- le quise meter aqui esto pero no va: and #producto.vendedor.nomUser == authentication.name"-->
        <td sec:authorize="isAuthenticated()">
          <a th:href="@{/producto/edit/{id}(id=${producto.idProd})}">Editar</a>
        </td>
        <!-- (solo si autenticado) --> <!-- le quise meter aqui esto pero no va: and #producto.vendedor.nomUser == authentication.name"-->
        <td sec:authorize="isAuthenticated()">
          <a th:href="@{/producto/delete/{id}(id=${producto.idProd})}">Borrar</a>
        </td>
      </tr>
    </tbody>
  </table>
  <!-- (solo si autenticado) -->
  <a sec:authorize="isAuthenticated()" th:href="@{/producto/new}">Nuevo producto</a><br />
</body>

<footer th:insert="/fragmentos.html::footer">
</footer>  

</html>